<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>INOVEX25 | Civic Reporter</title>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<!-- Leaflet for map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Open Location Code (Plus Codes) -->
<script src="https://cdn.jsdelivr.net/npm/open-location-code@1.0.4/open-location-code.min.js"></script>

<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:"Segoe UI",sans-serif;}
body{
  background: linear-gradient(135deg, #f0f4f8, #d9e2ef);
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  padding:20px;
}
.container{
  width:100%;
  max-width:900px;
  display:flex;
  gap:20px;
  flex-wrap:wrap;
}
.card{
  flex:1 1 350px;
  background:#fff;
  padding:24px;
  border-radius:16px;
  box-shadow:0 8px 24px rgba(0,0,0,0.12);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.card:hover{transform:translateY(-4px);box-shadow:0 12px 28px rgba(0,0,0,0.16);}
h2{text-align:center;margin-bottom:20px;color:#2c7be5;font-size:22px;}
label{font-weight:600;margin-top:12px;display:block;color:#333;font-size:15px;}
input,textarea{width:100%;padding:12px;margin-top:6px;border:1px solid #ccd6eb;border-radius:10px;font-size:15px;transition:border-color 0.3s,box-shadow 0.3s;}
input:focus,textarea:focus{border-color:#2c7be5;box-shadow:0 0 6px rgba(44,123,229,0.3);}
textarea{resize:none;}
button{
  margin-top:14px;padding:12px;width:100%;
  border:none;border-radius:12px;
  background: linear-gradient(135deg,#2c7be5,#00c6ff);
  color:white;font-size:16px;font-weight:600;cursor:pointer;
  box-shadow:0 6px 14px rgba(0,0,0,0.12);
  transition:0.3s;
}
button:hover{background: linear-gradient(135deg,#1b5fbd,#0090d3);}
#locDisplay{margin-top:8px;font-size:14px;color:#555;text-align:center;}
#status{margin-top:16px;text-align:center;font-weight:600;font-size:15px;padding:10px;border-radius:10px;transition:all 0.3s ease;}
.success{color:#0f8b3e;background:#e0f6e6;}
.error{color:#c23616;background:#ffe7e4;}
#preview{margin-top:16px;padding:20px;border-radius:16px;background:#fefefe;display:none;box-shadow:0 8px 20px rgba(0,0,0,0.12);}
#preview:hover{transform:translateY(-4px);box-shadow:0 12px 28px rgba(0,0,0,0.16);}
#preview img{max-width:100%;border-radius:12px;margin-top:12px;object-fit:cover;box-shadow:0 4px 12px rgba(0,0,0,0.1);}
#map{width:100%;height:250px;border-radius:12px;margin-top:12px;display:none;box-shadow:0 4px 12px rgba(0,0,0,0.1);}
#pDesc,#pLoc,#pAddr{color:#444;line-height:1.5;transition:color 0.3s,font-size 0.3s;}
@media(max-width:768px){.container{flex-direction:column;align-items:stretch;}#map{height:220px;}}
</style>
</head>
<body>
<div class="container">
  <!-- Form Card -->
  <div class="card">
    <h2><i class="fa-solid fa-triangle-exclamation"></i> Report Issue</h2>

    <label><i class="fa-solid fa-pen"></i> Description</label>
    <textarea id="desc" rows="3" placeholder="e.g. Overflowing drainage near park"></textarea>
    <button type="button" id="micBtn"><i class="fa-solid fa-microphone"></i> Speak</button>

    <label><i class="fa-solid fa-camera"></i> Upload Photo</label>
    <input id="photo" type="file" accept="image/*" capture="environment">

    <label><i class="fa-solid fa-location-dot"></i> Search Location</label>
    <input id="searchInput" type="text" placeholder="Enter address or landmark">
    <label><i class="fa-solid fa-map-location"></i> Or Manual Address</label>
    <input id="manualAddr" type="text" placeholder="Enter full address for reference">

    <button id="locBtn" type="button"><i class="fa-solid fa-location-dot"></i> Use My Location</button>
    <span id="locDisplay">Lat: -, Lng: -</span>

    <button id="submitBtn"><i class="fa-solid fa-paper-plane"></i> Submit Issue</button>
    <div id="status">You can drag the pin or search for address if location is inaccurate.</div>
  </div>

  <!-- Preview Card -->
  <div class="card" id="preview">
    <h2>üìã Preview</h2>
    <p id="pDesc"></p>
    <img id="pImg" src="" alt="">
    <p id="pLoc"></p>
    <p id="pAddr"></p>
    <div id="map"></div>
  </div>
</div>

<script>
const N8N_WEBHOOK_URL="https://your-n8n/webhook/report";
const CLOUD_NAME="your_cloud_name";
const UPLOAD_PRESET="your_unsigned_preset";

let lat=null,lng=null,accuracy=null;
const descEl=document.getElementById("desc");
const photoEl=document.getElementById("photo");
const preview=document.getElementById("preview");
const pDesc=document.getElementById("pDesc");
const pImg=document.getElementById("pImg");
const pLoc=document.getElementById("pLoc");
const pAddr=document.getElementById("pAddr");
const locBtn=document.getElementById("locBtn");
const submitBtn=document.getElementById("submitBtn");
const status=document.getElementById("status");
const mapDiv=document.getElementById("map");
const searchInput=document.getElementById("searchInput");
const manualAddr=document.getElementById("manualAddr");

let map,marker,circle;

function updatePreview(){
  if(descEl.value||photoEl.files[0]||(lat&&lng)){
    pDesc.textContent=descEl.value||"No description yet";
    if(photoEl.files[0]){pImg.src=URL.createObjectURL(photoEl.files[0]);pImg.style.display="block";}else{pImg.style.display="none";}
    pLoc.textContent=(lat&&lng)?`üìç ${lat}, ${lng} (¬±${accuracy||"?"} m)`:"";
    pAddr.textContent=manualAddr.value?`üè† Address: ${manualAddr.value}`:"";
    preview.style.display="block";
    if(lat&&lng) mapDiv.style.display="block";
  }else{preview.style.display="none";mapDiv.style.display="none";}
}
descEl.addEventListener("input",updatePreview);
photoEl.addEventListener("change",updatePreview);
manualAddr.addEventListener("input",updatePreview);

// Voice Input
document.getElementById("micBtn").onclick=()=>{
  if(!('webkitSpeechRecognition' in window)){alert("Speech recognition not supported");return;}
  const recog=new webkitSpeechRecognition();
  recog.lang="en-IN";
  recog.start();
  recog.onresult=(e)=>{ descEl.value+=" "+e.results[0][0].transcript; updatePreview(); };
};

// Map Init
function initMap(){
  if(!lat||!lng) return;
  if(!map){
    map=L.map('map').setView([lat,lng],17);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
    marker=L.marker([lat,lng],{draggable:true}).addTo(map);
    circle=L.circle([lat,lng],{radius:accuracy||30,color:'#2c7be5',fillColor:'#2c7be5',fillOpacity:0.1}).addTo(map);
    marker.on('dragend',()=>{const pos=marker.getLatLng();lat=pos.lat.toFixed(6);lng=pos.lng.toFixed(6);updatePreview();status.textContent="üìå Pin dragged. Coordinates updated. Adjust address if needed.";circle.setLatLng(pos);});
  }else{marker.setLatLng([lat,lng]);map.setView([lat,lng],17);circle.setLatLng([lat,lng]);}
}

// Location Button
locBtn.onclick=()=>{
  if(!navigator.geolocation){alert("Geolocation not supported"); return;}
  status.textContent="üìç Getting location‚Ä¶ If inaccurate, search or drag pin.";
  navigator.geolocation.getCurrentPosition((pos)=>{
    lat=pos.coords.latitude.toFixed(6);
    lng=pos.coords.longitude.toFixed(6);
    accuracy=Math.round(pos.coords.accuracy);
    document.getElementById("locDisplay").textContent=`Lat: ${lat}, Lng: ${lng} (¬±${accuracy} m)`;
    updatePreview();initMap();status.textContent="üìç Location detected. Adjust pin or address if needed.";
  },()=>{alert("Location not available");status.textContent="‚ùå Could not get location.";});
};

// Address Search
searchInput.addEventListener("keypress",async(e)=>{
  if(e.key==="Enter"){ e.preventDefault();
    const query=searchInput.value.trim();
    if(!query) return;
    status.textContent="üîç Searching address‚Ä¶";
    try{
      const res=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
      const data=await res.json();
      if(data.length===0){status.textContent="‚ö†Ô∏è Address not found. Drag pin manually.";return;}
      lat=parseFloat(data[0].lat).toFixed(6);
      lng=parseFloat(data[0].lon).toFixed(6);
      accuracy=50;
      updatePreview();
      initMap();
      map.setView([lat,lng],17);
      marker.setLatLng([lat,lng]);
      circle.setLatLng([lat,lng]);
      status.textContent="üîç Address found. Drag pin to fine-tune if needed.";
    }catch(err){console.error(err);status.textContent="‚ùå Search failed.";}
  }
});

// Cloudinary Upload
async function uploadToCloudinary(file){
  const url=`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`;
  const fd=new FormData();
  fd.append("upload_preset",UPLOAD_PRESET);
  fd.append("file",file);
  const r=await fetch(url,{method:"POST",body:fd});
  if(!r.ok) throw new Error("Cloudinary upload failed: "+r.status);
  const data=await r.json();
  return data.secure_url;
}

// Submit
submitBtn.onclick=async()=>{
  const desc=descEl.value.trim();
  const file=photoEl.files[0];
  if(!desc){alert("Please enter a description"); return;}
  if(!lat||!lng){alert("Please provide location by pin or search"); return;}
  submitBtn.disabled=true;
  status.textContent="‚è≥ Uploading...";status.className="";
  try{
    let photo_url="";
    if(file) photo_url=await uploadToCloudinary(file);
    const plusCode=openLocationCode.encode(lat,lng);
    const maps_link=`https://www.openstreetmap.org/?mlat=${lat}&mlon=${lng}&zoom=17`;
    const payload={description:desc,lat,lng,accuracy,photo_url,plus_code:plusCode,osm_link:maps_link,manual_address:manualAddr.value,source:"Web"};
    const r=await fetch(N8N_WEBHOOK_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
    if(!r.ok) throw new Error("n8n returned "+r.status);
    const data=await r.json();
    status.innerHTML=`‚úÖ Submitted!<br>Ticket: ${data.ticket_id||"N/A"}<br>Category: ${data.category||"Unknown"}<br>Sentiment: ${data.sentiment||"Neutral"}`;
    status.className="success";
  }catch(e){console.error(e);status.textContent="‚ùå "+e.message;status.className="error";}
  finally{submitBtn.disabled=false;}
};
</script>
</body>
</html>
