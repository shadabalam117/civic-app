<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Citizen Civic Sense — Ultimate (SIH-ready demo)</title>

<!-- Icons & Leaflet -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/open-location-code@1.0.4/open-location-code.min.js"></script>

<style>
  :root{
    --primary:#2c7be5; --accent:#00c6ff; --muted:#6b7280; --bg:#f4f7fb;
    --card:#fff; --danger:#e94e77; --success:#0f9d58;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;background:var(--bg);color:#111}
  /* Top bar */
  .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px;max-width:1200px;margin:12px auto}
  .brand{display:flex;gap:12px;align-items:center}
  .brand h1{margin:0;color:var(--primary);font-size:18px}
  .controls{display:flex;gap:8px;align-items:center}
  select,input.small{padding:8px;border-radius:8px;border:1px solid #e6eefc}
  /* Layout */
  .wrap{max-width:1200px;margin:0 auto;display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap;padding:12px}
  .panel{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 8px 28px rgba(17,24,39,0.06)}
  /* Form panel */
  .panel.form{flex:1 1 680px;min-width:320px}
  .panel.side{flex:1 1 360px;min-width:300px;max-height:80vh;overflow:auto}
  label{display:block;font-weight:700;margin-top:10px}
  input[type="text"],textarea,select,input[type="tel"],input[type="email"]{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eefc;margin-top:8px;font-size:14px}
  textarea{min-height:96px;resize:vertical}
  .row{display:flex;gap:8px}
  .col{flex:1}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px;border-radius:10px;border:none;background:linear-gradient(135deg,var(--primary),var(--accent));color:white;font-weight:800;cursor:pointer}
  .btn.ghost{background:#fff;color:var(--primary);border:1px solid #e6eefc}
  .btn.secondary{background:linear-gradient(135deg,#20c997,#0fb07a)}
  .small{padding:8px;font-size:13px}
  .note{font-size:13px;color:var(--muted);margin-top:6px}
  #map{width:100%;height:260px;border-radius:10px;margin-top:10px;display:none;border:1px solid #e6eefc}
  .photos-grid{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .photo-thumb{width:76px;height:76px;border-radius:8px;overflow:hidden;position:relative;border:1px solid #eef6ff}
  .photo-thumb img{width:100%;height:100%;object-fit:cover}
  .photo-thumb button{position:absolute;top:6px;right:6px;background:rgba(0,0,0,0.45);border:none;color:#fff;padding:4px;border-radius:6px;cursor:pointer}
  .status{margin-top:12px;padding:10px;border-radius:8px;font-weight:700}
  .status.info{background:#eef6ff;color:var(--primary)}
  .status.warn{background:#fff4e5;color:#a35d00}
  .status.success{background:#e9f7f0;color:var(--success)}
  .status.error{background:#fdecea;color:var(--danger)}
  .preview{display:none;margin-top:12px;padding:10px;border-radius:8px;background:#fbfdff;border:1px solid #eef6ff}
  .feed{margin-top:12px}
  .feed-item{padding:10px;border-radius:8px;border:1px solid #eef6ff;margin-bottom:8px;background:#fff}
  .hamburger{display:inline-flex;align-items:center;gap:8px;padding:8px;border-radius:8px;background:#fff;border:1px solid #e6eefc;cursor:pointer}
  .menu{position:fixed;top:12px;left:12px}
  /* responsive */
  @media(max-width:900px){
    .panel.form{flex-basis:100%}
    .panel.side{flex-basis:100%}
    .topbar{flex-direction:column;align-items:flex-start}
  }
  /* dark theme */
  .dark{--bg:#0b1220;--card:#071124;color:#e6eef8}
  .dark body, .dark html { background:var(--bg) }
  .dark .panel{background:#071124}
  .dark input, .dark textarea{background:#072034;color:#e6eef8;border:1px solid #123044}
  .dark .btn.ghost{background:#071124;color:var(--accent);border:1px solid #123044}
  .tiny{font-size:12px;color:var(--muted)}
  .flex-between{display:flex;justify-content:space-between;align-items:center}
</style>
</head>
<body>
  <!-- Topbar -->
  <div class="topbar">
    <div class="brand">
      <div class="menu">
        <button id="hamburgerBtn" class="hamburger"><i class="fa-solid fa-bars"></i> Menu</button>
      </div>
      <h1>Citizen Civic Sense</h1>
      <div class="note" id="topNote">Report civic issues, verify reports, and track resolutions — India-ready.</div>
    </div>

    <div class="controls">
      <label style="margin:0">UI Language</label>
      <select id="uiLang" class="small" title="Change UI language (affects labels & placeholders)">
        <!-- many options (codes match translations object below) -->
        <option value="en">English</option>
        <option value="hi">हिन्दी</option>
        <option value="bn">বাংলা</option>
        <option value="te">తెలుగు</option>
        <option value="ta">தமிழ்</option>
        <option value="mr">मराठी</option>
        <option value="kn">ಕನ್ನಡ</option>
        <option value="gu">ગુજરાતી</option>
        <option value="ml">മലയാളം</option>
        <option value="or">ଓଡ଼ିଆ</option>
        <option value="pa">ਪੰਜਾਬੀ</option>
        <option value="as">অসমীয়া</option>
        <option value="ur">اردو</option>
        <option value="ne">नेपाली</option>
        <option value="sa">संस्कृत</option>
        <option value="sd">سنڌي</option>
        <option value="kok">कोंकणी</option>
        <option value="brx">बोडो</option>
        <option value="doi">डोगरी</option>
        <option value="ks">کٲشُر (کشميري)</option>
        <option value="mni">মৈতৈ (মণিপুরি)</option>
        <option value="sat">ᱥᱟᱱᱛᱟᱲ (Santhali)</option>
      </select>

      <label style="margin:0">Theme</label>
      <select id="themeSel" class="small">
        <option value="light">Light</option>
        <option value="dark">Dark</option>
      </select>

      <label style="margin:0">Mic language</label>
      <select id="micLang" class="small" title="Language for speech input">
        <option value="en-IN">English (India)</option>
        <option value="hi-IN">हिन्दी</option>
        <option value="bn-IN">বাংলা</option>
        <option value="mr-IN">मराठी</option>
        <option value="ta-IN">தமிழ்</option>
        <option value="te-IN">తెలుగు</option>
        <option value="kn-IN">ಕನ್ನಡ</option>
        <option value="gu-IN">ગુજરાતી</option>
        <option value="ml-IN">മലയാളം</option>
        <option value="or-IN">ଓଡ଼ିଆ</option>
        <option value="pa-IN">ਪੰਜਾਬੀ</option>
        <option value="as-IN">অসমীয়া</option>
        <option value="ur-IN">اردو</option>
      </select>
    </div>
  </div>

  <!-- Main -->
  <div class="wrap">
    <!-- Form panel -->
    <section class="panel form" id="reportPanel">
      <div class="flex-between">
        <div>
          <h2 style="margin:0">Report Issue</h2>
          <div class="tiny">Mobile-first. Use GPS, search, or drag pin to set exact location.</div>
        </div>
        <div style="text-align:right">
          <div class="tiny">Your reporter ID: <strong id="reporterIdDisplay">-</strong></div>
          <div class="tiny">Trust: <strong id="trustScore">0</strong>%</div>
        </div>
      </div>

      <label id="lbl_category">Category</label>
      <select id="category">
        <option value="">— Select category —</option>
        <option>Garbage / Sanitation</option>
        <option>Road / Pothole</option>
        <option>Drainage / Waterlogging</option>
        <option>Streetlights / Electricity</option>
        <option>Water Supply</option>
        <option>Public Toilet</option>
        <option>Encroachment / Illegal Construction</option>
        <option>Noise Pollution</option>
        <option>Stray Animals</option>
        <option>Safety / Police</option>
        <option>Tree / Parks</option>
        <option>Other</option>
      </select>

      <label id="lbl_description">Description</label>
      <textarea id="desc" placeholder="Describe the issue in detail..."></textarea>

      <div class="row">
        <div class="col">
          <label id="lbl_mic">Speech to text (mic)</label>
        </div>
        <div style="width:140px">
          <label>&nbsp;</label>
          <button id="micBtn" class="btn small"><i class="fa-solid fa-microphone"></i> <span id="micBtnLabel">Speak</span></button>
        </div>
      </div>

      <label id="lbl_photos">Photos (max 4)</label>
      <input id="photoInput" type="file" accept="image/*" multiple>
      <div class="photos-grid" id="photosGrid"></div>
      <div class="note" id="photosNote">We compress images client-side to save data. Max 4 photos.</div>

      <label id="lbl_search">Location — Search (address / landmark)</label>
      <input id="searchInput" type="text" placeholder="Start typing address or landmark..." autocomplete="off">
      <div id="suggestions"></div>

      <label id="lbl_manual">Or manual address (reference)</label>
      <input id="manualAddr" type="text" placeholder="Full address or landmark for officials">

      <div class="row">
        <div class="col">
          <label>&nbsp;</label>
          <button id="locBtn" class="btn secondary small"><i class="fa-solid fa-location-dot"></i> Use My Location</button>
        </div>
        <div class="col">
          <label>&nbsp;</label>
          <button id="openMapBtn" class="btn ghost small"><i class="fa-solid fa-map-pin"></i> Show / Adjust Pin</button>
        </div>
      </div>

      <div id="locDisplay" class="note">Lat: -, Lng: - (accuracy: - m)</div>
      <div id="map"></div>

      <label style="margin-top:8px"><input id="anonymous" type="checkbox"> <span id="lbl_anonymous">Report anonymously</span></label>

      <div id="contactFields" style="display:block">
        <label id="lbl_name">Your name (optional)</label>
        <input id="nameInput" type="text" placeholder="Name (optional)">
        <label id="lbl_phone">Your phone (optional)</label>
        <input id="phoneInput" type="tel" placeholder="Phone (optional)">
      </div>

      <div class="row" style="margin-top:12px">
        <div class="col">
          <label id="lbl_priority">Priority (optional)</label>
          <select id="priority"><option>Normal</option><option>High</option><option>Urgent</option></select>
        </div>
        <div class="col">
          <label>&nbsp;</label>
          <button id="submitBtn" class="btn"><i class="fa-solid fa-paper-plane"></i> Submit Report</button>
        </div>
      </div>

      <div id="formStatus" class="status info">Tip: If GPS accuracy is low, search or drag the pin. Duplicate reports nearby will be flagged.</div>
      <div style="margin-top:10px" class="note">Demo: reports saved in browser localStorage. Configure webhook/cloudinary at top of file to send to server.</div>
    </section>

    <!-- Side panel: preview, feed, settings, gamification -->
    <aside class="panel side">
      <div class="flex-between">
        <h3 id="previewTitle">Preview</h3>
        <div class="tiny" id="notifArea">Notifications: <span id="notifCount">0</span></div>
      </div>

      <div class="preview" id="previewBox">
        <div class="flex-between">
          <div><span id="previewCat" class="tag"></span></div>
          <div class="tiny" id="previewCoords">—</div>
        </div>
        <div id="previewDesc" style="font-weight:700;margin-top:6px"></div>
        <div id="previewPhotos"></div>
        <div id="previewAddr" class="note" style="margin-top:8px"></div>
      </div>

      <div style="margin-top:12px">
        <h4>Recent Reports</h4>
        <div id="feed" class="feed"></div>
        <div style="margin-top:8px" class="row">
          <button id="exportCSV" class="btn ghost small"><i class="fa-solid fa-file-csv"></i> Export CSV</button>
          <button id="clearStorage" class="btn ghost small"><i class="fa-solid fa-trash"></i> Clear Demo Storage</button>
        </div>
      </div>

      <hr style="margin:12px 0">

      <div>
        <h4>Gamification</h4>
        <div class="tiny">Points: <strong id="pointsCount">0</strong></div>
        <div class="tiny">Badges: <span id="badges">—</span></div>
        <div style="margin-top:8px">
          <button id="leaderboardBtn" class="btn ghost small"><i class="fa-solid fa-trophy"></i> Leaderboard</button>
        </div>
      </div>

      <hr style="margin:12px 0">
      <div>
        <h4>Settings (quick)</h4>
        <label><input id="notifToggle" type="checkbox"> Browser Notifications</label>
        <div class="tiny">Allow browser notifications to get updates about your reported tickets (demo only).</div>
      </div>
    </aside>
  </div>

  <!-- Hamburger menu modal -->
  <div id="hamburgerModal" style="display:none;position:fixed;top:12px;left:12px;background:#fff;border:1px solid #e6eefc;padding:12px;border-radius:8px;z-index:9999;box-shadow:0 12px 40px rgba(0,0,0,0.12)">
    <div class="flex-between"><strong>Menu</strong><button id="closeMenu" class="btn ghost small">Close</button></div>
    <ul style="list-style:none;padding:8px 0;margin:0">
      <li><button id="menuAbout" class="btn ghost small" style="width:100%;text-align:left">About</button></li>
      <li><button id="menuFAQ" class="btn ghost small" style="width:100%;text-align:left">FAQ</button></li>
      <li><button id="menuSupport" class="btn ghost small" style="width:100%;text-align:left">Contact Support</button></li>
      <li><button id="menuHistory" class="btn ghost small" style="width:100%;text-align:left">My Reports (History)</button></li>
      <li><button id="menuModerator" class="btn ghost small" style="width:100%;text-align:left">Moderator Dashboard</button></li>
      <li><button id="menuTheme" class="btn ghost small" style="width:100%;text-align:left">Theme</button></li>
      <li><button id="menuLogout" class="btn ghost small" style="width:100%;text-align:left">Reset Demo</button></li>
    </ul>
  </div>

<script>
/* =========================================
   Ultimate Civic Sense — Single-file demo
   - Configure webhook/cloudinary at top for server integration
   - Large feature set, India-focused anti-abuse heuristics
   ========================================= */

/* ------------------------
  Configuration (change as needed)
   - Set N8N_WEBHOOK_URL to your n8n endpoint if present (optional)
   - If using Cloudinary, set CLOUD_NAME & UPLOAD_PRESET (unsigned)
*/
const N8N_WEBHOOK_URL = "https://your-n8n/webhook/report"; // replace or leave
const CLOUD_NAME = ""; // e.g. "my_cloud"
const UPLOAD_PRESET = ""; // unsigned preset name

/* ------------------------
  Utilities & storage keys
*/
const STORAGE_KEY = "civic_ultimate_reports_v1";
const REPORTER_KEY = "civic_ultimate_reporter_v1";
const SETTINGS_KEY = "civic_ultimate_settings_v1";
function uid(len=8){ return Math.random().toString(36).slice(2,2+len); }
function nowISO(){ return new Date().toISOString(); }
function saveJSON(key,obj){ localStorage.setItem(key, JSON.stringify(obj)); }
function loadJSON(key, fallback){ try{ return JSON.parse(localStorage.getItem(key)||JSON.stringify(fallback)); }catch(e){ return fallback; } }

/* ------------------------
  Reporter identity & trust system
*/
function initReporter(){
  let r = loadJSON(REPORTER_KEY, {});
  if(!r.id){ r.id = 'r_'+uid(10); r.valid = 0; r.invalid = 0; r.points = 0; r.badges = []; saveJSON(REPORTER_KEY, r); }
  return r;
}
function getReporter(){ return initReporter(); }
function updateReporter(up){ const r = getReporter(); Object.assign(r, up); saveJSON(REPORTER_KEY, r); updateReporterUI(); }
function trustScore(){ const r = getReporter(); const total = (r.valid||0) + (r.invalid||0); return total ? Math.round(((r.valid||0)/total)*100) : 0; }

/* ------------------------
  Settings (persisted)
*/
const defaultSettings = { uiLang: 'en', theme: 'light', notif: false, anonymousDefault: false, submissionCooldownSec: 30 };
function loadSettings(){ return loadJSON(SETTINGS_KEY, defaultSettings); }
function saveSettings(s){ saveJSON(SETTINGS_KEY, s); applySettingsUI(); }

/* ------------------------
  DOM elements shortcuts
*/
const reporterIdDisplay = document.getElementById('reporterIdDisplay');
const trustScoreEl = document.getElementById('trustScore');
const pointsCountEl = document.getElementById('pointsCount');
const badgesEl = document.getElementById('badges');
const photosGrid = document.getElementById('photosGrid');
const photoInput = document.getElementById('photoInput');
const descEl = document.getElementById('desc');
const categoryEl = document.getElementById('category');
const micBtn = document.getElementById('micBtn');
const micLang = document.getElementById('micLang');
const micBtnLabel = document.getElementById('micBtnLabel');
const photoNote = document.getElementById('photosNote');
const suggestionsDiv = document.getElementById('suggestions');
const searchInput = document.getElementById('searchInput');
const manualAddr = document.getElementById('manualAddr');
const locBtn = document.getElementById('locBtn');
const openMapBtn = document.getElementById('openMapBtn');
const mapDiv = document.getElementById('map');
const locDisplay = document.getElementById('locDisplay');
const submitBtn = document.getElementById('submitBtn');
const previewBox = document.getElementById('previewBox');
const previewCat = document.getElementById('previewCat');
const previewDesc = document.getElementById('previewDesc');
const previewCoords = document.getElementById('previewCoords');
const previewAddr = document.getElementById('previewAddr');
const previewPhotos = document.getElementById('previewPhotos');
const feedEl = document.getElementById('feed');
const formStatus = document.getElementById('formStatus');
const uiLangSel = document.getElementById('uiLang');
const themeSel = document.getElementById('themeSel');
const notifToggle = document.getElementById('notifToggle');
const notifCountEl = document.getElementById('notifCount');
const hamburgerBtn = document.getElementById('hamburgerBtn');
const hamburgerModal = document.getElementById('hamburgerModal');
const closeMenuBtn = document.getElementById('closeMenu');
const menuAbout = document.getElementById('menuAbout');
const menuFAQ = document.getElementById('menuFAQ');
const menuSupport = document.getElementById('menuSupport');
const menuHistory = document.getElementById('menuHistory');
const menuModerator = document.getElementById('menuModerator');
const menuTheme = document.getElementById('menuTheme');
const menuLogout = document.getElementById('menuLogout');
const exportCSVBtn = document.getElementById('exportCSV');
const clearStorageBtn = document.getElementById('clearStorage');
const leaderboardBtn = document.getElementById('leaderboardBtn');
const anonymousChk = document.getElementById('anonymous');
const contactFields = document.getElementById('contactFields');

/* ------------------------
  Translations (UI text) — condensed for brevity but includes 22+ languages
  NOTE: For production, move translations to JSON files and have native speaker QA.
*/
const translations = {
  "en": { "report_issue":"Report Issue","description":"Description","speak":"Speak","photos":"Photos (max 4)","search":"Search location","manual":"Manual address","use_location":"Use My Location","show_pin":"Show / Adjust Pin","anonymous":"Report anonymously","submit":"Submit Report","tip":"Tip: If GPS accuracy is low, search or drag the pin." },
  "hi": { "report_issue":"समस्या दर्ज करें","description":"विवरण","speak":"बोलें","photos":"फ़ोटो (अधिकतम 4)","search":"स्थान खोजें","manual":"मैन्युअल पता","use_location":"मेरा स्थान उपयोग करें","show_pin":"पिन दिखाएँ/समायोजित करें","anonymous":"गुमनाम रूप से रिपोर्ट करें","submit":"रिपोर्ट भेजें","tip":"यदि GPS सटीकता कम है तो खोजें या पिन खींचें।" },
  "bn": { "report_issue":"সমস্যা রিপোর্ট করুন","description":"বর্ণনা","speak":"কথা বলুন","photos":"ছবি (সর্বোচ্চ 4)","search":"অবস্থান খুঁজুন","manual":"ম্যানুয়াল ঠিকানা","use_location":"আমার অবস্থান ব্যবহার করুন","show_pin":"পিন দেখান/অ্যাডজাস্ট করুন","anonymous":"অজ্ঞাতভাবে রিপোর্ট করুন","submit":"রিপোর্ট জমা দিন","tip":"যদি GPS সঠিকতা কম হয় তবে খুঁজুন বা পিন টানুন।" },
  "te": { "report_issue":"సమస్య నివేదిక","description":"వివరణ","speak":"మాట్లాడు","photos":"ఫోటోలు (4 వరకే)","search":"స్థలాన్ని వెతకండి","manual":"మాన్యువల్ చిరునామా","use_location":"నా స్థానం వాడండి","show_pin":"పిన్ చూపించు/సవరించు","anonymous":"గొప్యంగా నివేదించు","submit":"పంపి వేయి","tip":"GPS ఖచ్చితత్వం తక్కువ అయితే వెతకండి లేదా పిన్‌ను డ్రాగ్ చేయండి." },
  "ta": { "report_issue":"பிரச்சனை அறிவிக்கவும்","description":"விளக்கம்","speak":"பேசவும்","photos":"புகைப்படங்கள் (அதி. 4)","search":"இடத்தை தேடு","manual":"கையால் உள்ள முகவரி","use_location":"என் இருப்பிடம் பயன்படுத்தவும்","show_pin":"பின் காட்டு/சரிசெய்","anonymous":"அறியாமலாக புகார் கொடுங்கள்","submit":"அறிக்கை சமர்ப்பி","tip":"GPS துல்லியம் குறைந்தால் தேடவும் அல்லது பின் இழுக்கவும்." },
  "mr": { "report_issue":"समस्या नोंदवा","description":"वर्णन","speak":"बोल","photos":"फोटो (कमाल 4)","search":"ठिकाण शोधा","manual":"मॅन्युअल पत्ता","use_location":"माझे स्थान वापरा","show_pin":"पिन दाखवा/सुधारा","anonymous":"गोपनीयपणे नोंदवा","submit":"रिपोर्ट सादर करा","tip":"GPS अचूकता कमी असल्यास शोधा किंवा पिन ड्रॅग करा." },
  "kn": { "report_issue":"ಸಮಸ್ಯೆ ವರದಿ ಮಾಡಿ","description":"ವಿವರಣೆ","speak":"ಮಾತನಾಡಿ","photos":"ಫೋಟೋಗಳು (ಗರಿಷ್ಠ 4)","search":"ಉದ್ಧೇಶ ಹುಡುಕಿ","manual":"ಮ್ಯಾನ್ಯುವಲ್ ವಿಳಾಸ","use_location":"ನನ್ನ ಸ್ಥಾನ ಬಳಸಿ","show_pin":"ಪಿನ್ ತೋರಿಸಿ/ನಿಪುಣಗೊಳಿಸಿ","anonymous":"ಗೋಚರವಾಗಿ ವರದಿ ಮಾಡಿ","submit":"ವರದಿ ಸಲ್ಲಿಸಿ","tip":"GPS ನಿಖರತೆ ಕಡಿಮೆಯಾದರೆ ಹುಡುಕಿ ಅಥವಾ ಪಿನ್ ಅನ್ನು ಎಳೆಯಿರಿ." },
  "gu": { "report_issue":"સમસ્યા રિપોર્ટ કરો","description":"વર્ણન","speak":"બોલો","photos":"ફોટા (સર્વોચ્ચ 4)","search":"સ્થળ શોધો","manual":"મેન્યુઅલ સરનામું","use_location":"મારું સ્થાન વાપરો","show_pin":"પીન બતાવો/સુધારો","anonymous":"નામ ન બતાવી રિપોર્ટ કરો","submit":"રિપોર્ટ સબમિટ કરો","tip":"GPS ચોકસાઈ નાની હોય તો શોધો અથવા પિન ખેંચો." },
  "ml": { "report_issue":"പ്രശ്നം റിപ്പോർട്ട് ചെയ്യുക","description":"വിവരണം","speak":"പറയൂ","photos":"ഫോട്ടോകൾ (മാസ് 4)","search":"സ്ഥലം തിരയൂ","manual":"മാന്വൽ വിലാസം","use_location":"എന്റെ സ്ഥലം ഉപയോഗിക്കൂ","show_pin":"പിൻ കാണിക്കുക/കൃത്യമായത്","anonymous":"അജ്ഞാതമായി റിപ്പോർട്ട് ചെയ്യുക","submit":"റിപ്പോർട്ട് സമർപ്പിക്കുക","tip":"GPS കൃത്യത കുറഞ്ഞാൽ തിരയുക അല്ലെങ്കിൽ പിന്‍ ഡ്രാഗ് ചെയ്യുക." },
  "or": { "report_issue":"ସମସ୍ୟା ରିପୋର୍ଟ କରନ୍ତୁ","description":"ବର୍ଣ୍ଣନା","speak":"କଥା କହନ୍ତୁ","photos":"ଫଟୋ (ଅଧିକତମ 4)","search":"ଜାଗା ଖୋଜନ୍ତୁ","manual":"ମାନୁଆଲ୍ ଠିକଣା","use_location":"ମୋର ସ୍ଥାନ ବ୍ୟବହାର କରନ୍ତୁ","show_pin":"ପିନ୍ ଦେଖାନ୍ତୁ/ସଂଶୋଧନ","anonymous":"ଅଜ୍ଞାତ ଭାବେ ରିପୋର୍ଟ କରନ୍ତୁ","submit":"ରିପୋର୍ଟ ପ୍ରେରଣ କରନ୍ତୁ","tip":"GPS ସଠିକତା କମ୍ ଥିଲେ ଖୋଜନ୍ତୁ କିମ୍ବା ପିନ୍ ଟାଣନ୍ତୁ." },
  "pa": { "report_issue":"ਰਿਪੋਰਟ ਕਰੋ","description":"ਵੇਰਵਾ","speak":"ਬੋਲੋ","photos":"ਫੋਟੋ (4 ਤੱਕ)","search":"ਟਿਕਾਣਾ ਖੋਜੋ","manual":"ਮੈਨੂਅਲ ਪਤਾ","use_location":"ਮੇਰੀ ਥਾਂ ਵਰਤੋ","show_pin":"ਪਿਨ ਦਿਖਾਓ/ਸੁਧਾਰੋ","anonymous":"ਗੁਪਤ ਰਿਪੋਰਟ","submit":"ਰਿਪੋਰਟ ਭੇਜੋ","tip":"ਜੇ GPS ਅਣਸ਼ੁੱਧ ਹੋਵੇ ਤਾਂ ਖੋਜੋ ਜਾਂ ਪਿਨ ਖਿੱਚੋ." },
  "as": { "report_issue":"ৰিপৰ্ট কৰক","description":"বিৱৰণ","speak":"ক'ব","photos":"ফটো (সৰ্বোচ্চ 4)","search":"স্থান বিচৰা","manual":"ম্যানুয়েল ঠিকনা","use_location":"মোৰ স্থান ব্যৱহাৰ কৰক","show_pin":"পিন দেখুৱাওক/সাজাওক","anonymous":"অজ্ঞাতভাৱে ৰিপৰ্ট কৰক","submit":"জমা কৰক","tip":"GPS সঠিকতা কম থাকিলে বিচাৰক বা পিন টানক." },
  "ur": { "report_issue":"مسئلہ رپورٹ کریں","description":"تفصیل","speak":"بولیں","photos":"تصاویر (زیادہ سے زیادہ 4)","search":"مقام تلاش کریں","manual":"دستی پتہ","use_location":"میری جگہ استعمال کریں","show_pin":"پن دکھائیں/درست کریں","anonymous":"گمنام رپورٹ کریں","submit":"رپورٹ جمع کریں","tip":"اگر GPS درستگی کم ہو تو تلاش کریں یا پن کھینچیں." },
  "ne": { "report_issue":"समस्या रिपोर्ट गर्नुहोस्","description":"विवरण","speak":"बोल्नुहोस्","photos":"फोटो (अधिकतम 4)","search":"स्थान खोज्नुहोस्","manual":"म्यानुअल ठेगाना","use_location":"मेरो स्थान प्रयोग गर्नुहोस्","show_pin":"पिन देखाउनुहोस्/समायोजन गर्नुहोस्","anonymous":"नाम नबताई रिपोर्ट गर्नुहोस्","submit":"रिपोर्ट पेश गर्नुहोस्","tip":"यदि GPS सटीकता कम छ भने खोज्नुहोस् वा पिन तान्नुहोस्." },
  /* Less-common languages: placeholders (please review) */
  "sa": {"report_issue":"रिपोर्ट","description":"वर्णन","speak":"वद","photos":"छायाचित्र (4)","search":"स्थान खोज","manual":"हस्तलिखित","use_location":"मम स्थानम्","show_pin":"पिन्","anonymous":"गुमनाम","submit":"पठय","tip":"GPS यदी अल्पम्"}
  /* More can be added / refined */
};

/* Apply UI language: updates some key labels & placeholders */
function applyUILang(code){
  const t = translations[code] || translations['en'];
  document.getElementById('lbl_category').textContent = t['report_issue'] ? 'Category' : 'Category'; // keep category label generic
  document.getElementById('lbl_description').textContent = t['description'] || 'Description';
  document.getElementById('micBtnLabel').textContent = t['speak'] || 'Speak';
  document.getElementById('photosNote').textContent = t['photos_note'] || photoNote.textContent;
  document.getElementById('lbl_search').textContent = t['search'] || 'Search location';
  document.getElementById('lbl_manual').textContent = t['manual'] || 'Manual address';
  document.getElementById('locBtn').textContent = (t['use_location'] || 'Use My Location');
  document.getElementById('openMapBtn').textContent = (t['show_pin'] || 'Show / Adjust Pin');
  document.getElementById('lbl_anonymous').textContent = (t['anonymous'] || 'Report anonymously');
  document.getElementById('lbl_name').textContent = (t['your_name'] || 'Your name (optional)');
  document.getElementById('lbl_phone').textContent = (t['your_phone'] || 'Your phone (optional)');
  document.getElementById('submitBtn').querySelector('span') ? document.getElementById('submitBtn').querySelector('span').textContent = (t['submit'] || 'Submit Report') : document.getElementById('submitBtn').textContent = (t['submit'] || 'Submit Report');
  formStatus.textContent = (t['tip'] || 'Tip: If GPS accuracy is low, search or drag the pin.');
}

/* ------------------------
  Initial setup: settings & reporter
*/
let SETTINGS = loadSettings();
let REPORTER = getReporter();
function applySettingsUI(){
  document.getElementById('uiLang').value = SETTINGS.uiLang || 'en';
  if(SETTINGS.theme === 'dark') document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark');
  document.getElementById('notifToggle').checked = SETTINGS.notif;
  document.getElementById('reporterIdDisplay').textContent = REPORTER.id;
  document.getElementById('trustScore').textContent = trustScore();
  document.getElementById('pointsCount').textContent = REPORTER.points || 0;
  document.getElementById('badges').textContent = (REPORTER.badges && REPORTER.badges.length) ? REPORTER.badges.join(', ') : '-';
  applyUILang(SETTINGS.uiLang || 'en');
}
applySettingsUI();

/* update settings when UI selects */
uiLangSel.addEventListener('change', (e)=>{ SETTINGS.uiLang = e.target.value; saveSettings(SETTINGS); applySettingsUI(); });
themeSel.addEventListener('change', (e)=>{ SETTINGS.theme = e.target.value; saveSettings(SETTINGS); applySettingsUI(); });
notifToggle.addEventListener('change', (e)=>{ SETTINGS.notif = e.target.checked; saveSettings(SETTINGS); applySettingsUI(); });

/* ------------------------
  Photos: compress, preview, limit
*/
let photos = []; // {name,dataUrl,size}
const MAX_PHOTOS = 4;
const MAX_BYTES = 5*1024*1024;
function dataURLtoBlob(dataurl){ const arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1], bstr = atob(arr[1]), n=bstr.length, u8=new Uint8Array(n); while(n--) u8[n] = bstr.charCodeAt(n); return new Blob([u8], {type:mime}); }
function compressImageFile(file, maxW=1280, quality=0.75){ return new Promise((resolve,reject)=>{ const img = new Image(); const url = URL.createObjectURL(file); img.onload = ()=>{ let w=img.naturalWidth,h=img.naturalHeight, scale=Math.min(1, maxW/w); w=Math.round(w*scale); h=Math.round(h*scale); const c=document.createElement('canvas'); c.width=w; c.height=h; const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,w,h); try{ const dataUrl=c.toDataURL('image/jpeg', quality); URL.revokeObjectURL(url); resolve(dataUrl); }catch(e){ URL.revokeObjectURL(url); reject(e); } }; img.onerror=(e)=>{ URL.revokeObjectURL(url); reject(e); }; img.src = url; }); }
photoInput.addEventListener('change', async (e)=>{ const files = Array.from(e.target.files||[]); for(const f of files){ if(photos.length>=MAX_PHOTOS){ alert('Max photos reached'); break; } if(f.size < 3000){ alert('Image too small'); continue; } try{ formStatus.textContent='Compressing photo...'; const dataUrl = await compressImageFile(f, 1280, 0.75); const blob = dataURLtoBlob(dataUrl); if(blob.size > MAX_BYTES){ formStatus.textContent='Compressed image too large. Try smaller photo.'; continue; } photos.push({name:f.name, dataUrl, size:blob.size}); renderPhotos(); formStatus.textContent='Photo added'; }catch(err){ console.error(err); formStatus.textContent='Photo error'; } } e.target.value=''; updatePreview(); });

function renderPhotos(){ photosGrid.innerHTML=''; previewPhotos.innerHTML=''; photos.forEach((p,i)=>{ const wrap=document.createElement('div'); wrap.className='photo-thumb'; const img=document.createElement('img'); img.src=p.dataUrl; const btn=document.createElement('button'); btn.innerHTML='<i class="fa-solid fa-xmark"></i>'; btn.onclick=()=>{ photos.splice(i,1); renderPhotos(); updatePreview(); }; wrap.appendChild(img); wrap.appendChild(btn); photosGrid.appendChild(wrap); const big=document.createElement('img'); big.src=p.dataUrl; big.style.maxWidth='100%'; big.style.borderRadius='8px'; big.style.marginTop='8px'; previewPhotos.appendChild(big); }); }

/* ------------------------
  Map & geolocation + Leaflet marker
*/
let map, marker, accuracyCircle, currentLat=null, currentLng=null, currentAccuracy=null;
function initMap(){ if(!map){ map = L.map('map').setView([20.5937,78.9629],5); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap contributors'}).addTo(map); } }
function showMap(){ initMap(); mapDiv.style.display='block'; setTimeout(()=>map.invalidateSize(),200); }
function setMarker(lat,lng,accuracy){ initMap(); currentLat = Number(lat); currentLng = Number(lng); currentAccuracy = accuracy||50; if(!marker){ marker = L.marker([currentLat,currentLng],{draggable:true}).addTo(map); marker.on('dragend', ()=>{ const pos = marker.getLatLng(); currentLat=pos.lat; currentLng=pos.lng; if(accuracyCircle) accuracyCircle.setLatLng([currentLat,currentLng]); updateLocDisplay(); updatePreview(); checkDuplicatesBeforeSubmit(); showStatus('Pin dragged. Coordinates updated.','info'); }); } else { marker.setLatLng([currentLat,currentLng]); } if(!accuracyCircle){ accuracyCircle = L.circle([currentLat,currentLng], {radius:currentAccuracy, color:varColor('--primary'), fillColor:varColor('--primary'), fillOpacity:0.08}).addTo(map); } else { accuracyCircle.setLatLng([currentLat,currentLng]); accuracyCircle.setRadius(currentAccuracy||50); } map.setView([currentLat,currentLng],17); mapDiv.style.display='block'; updateLocDisplay(); updatePreview(); }

function varColor(name){ try{ return getComputedStyle(document.documentElement).getPropertyValue(name).trim() || '#2c7be5'; }catch(e){ return '#2c7be5'; } }

locBtn.addEventListener('click', ()=>{ if(!navigator.geolocation){ alert('Geolocation not supported'); return; } showStatus('Getting high-accuracy location...', 'info'); navigator.geolocation.getCurrentPosition((pos)=>{ setMarker(pos.coords.latitude, pos.coords.longitude, Math.round(pos.coords.accuracy||50)); showStatus('Location detected. Drag pin or search if needed.', (pos.coords.accuracy>50?'warn':'success')); }, (err)=>{ console.warn(err); showStatus('Could not get GPS location', 'error'); }, {enableHighAccuracy:true, timeout:10000, maximumAge:0}); });

openMapBtn.addEventListener('click', ()=>{ showMap(); if(currentLat && currentLng) setMarker(currentLat, currentLng, currentAccuracy); else map.setView([20.5937,78.9629],5); });

function updateLocDisplay(){ if(currentLat && currentLng) locDisplay.textContent = `Lat: ${currentLat.toFixed(6)}, Lng: ${currentLng.toFixed(6)} (±${currentAccuracy||'?' } m)`; else locDisplay.textContent='Lat: -, Lng: - (accuracy: - m)'; }

/* ------------------------
  Search autocomplete (Nominatim)
*/
let searchTimer;
searchInput.addEventListener('input', (e)=>{ const q = e.target.value.trim(); suggestionsDiv.innerHTML=''; if(!q) return; clearTimeout(searchTimer); searchTimer = setTimeout(async ()=>{ try{ const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&q=${encodeURIComponent(q)}&limit=6`); const data = await res.json(); if(!data || !data.length) return; const list = document.createElement('div'); list.id='suggestionsList'; data.forEach(item=>{ const d = document.createElement('div'); d.style.padding='8px'; d.style.cursor='pointer'; d.textContent = item.display_name; d.onclick = ()=>{ setMarker(Number(item.lat), Number(item.lon), 50); manualAddr.value = item.display_name; suggestionsDiv.innerHTML=''; showStatus('Address found. Drag pin to fine-tune if needed.','success'); }; list.appendChild(d); }); suggestionsDiv.appendChild(list); }catch(err){ console.error(err); } }, 300); });

/* ------------------------
  Preview rendering
*/
function updatePreview(){ previewCat.textContent = categoryEl.value || 'Uncategorized'; previewDesc.textContent = descEl.value || '(No description)'; previewAddr.textContent = manualAddr.value ? 'Address: '+manualAddr.value : ''; previewCoords.textContent = (currentLat && currentLng) ? `📍 ${currentLat.toFixed(6)}, ${currentLng.toFixed(6)} (±${currentAccuracy||'?' } m)` : ''; previewPhotos.innerHTML=''; photos.forEach(p=>{ const i=document.createElement('img'); i.src=p.dataUrl; i.style.maxWidth='100%'; i.style.borderRadius='8px'; i.style.marginTop='8px'; previewPhotos.appendChild(i); }); previewBox.style.display='block'; }

/* ------------------------
  Speech-to-text (mic)
*/
micBtn.addEventListener('click', ()=>{ if(!('webkitSpeechRecognition' in window)){ alert('Speech recognition not supported in this browser. Use Chrome/Edge.'); return; } const r = new webkitSpeechRecognition(); r.lang = document.getElementById('micLang').value || 'en-IN'; r.interimResults = false; r.continuous = false; r.start(); showStatus('Listening...', 'info'); r.onresult = (e)=>{ const t = e.results[0][0].transcript; descEl.value = (descEl.value + ' ' + t).trim(); updatePreview(); showStatus('Speech recognized', 'success'); }; r.onerror = (ev)=>{ console.warn(ev); showStatus('Speech error', 'error'); } });

/* ------------------------
  Duplicate detection & distance heuristics
*/
function haversine(lat1,lon1,lat2,lon2){ function toRad(d){ return d*Math.PI/180; } const R=6371; const dLat=toRad(lat2-lat1); const dLon=toRad(lon2-lon1); const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2); const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); return R*c; } // km

function findNearbyDuplicates(lat,lng,category, radiusKm=0.2){
  const list = loadReports();
  const close = list.filter(r=> r.lat && r.lng && r.category === category && haversine(lat,lng,Number(r.lat),Number(r.lng)) <= radiusKm);
  return close;
}
function checkDuplicatesBeforeSubmit(){ if(!currentLat || !currentLng) return []; const dup = findNearbyDuplicates(currentLat,currentLng, categoryEl.value, 0.2); if(dup.length){ showStatus(`Warning: ${dup.length} similar report(s) found nearby. Consider confirming or adding details.`, 'warn'); } return dup; }

/* ------------------------
  Rate limiting: cooldown per reporter
*/
function canSubmitNow(){
  const s = loadJSON('civic_rate', {}); const now = Date.now(); const last = s[REPORTER.id] || 0; const cooldown = (SETTINGS.submissionCooldownSec || 30) * 1000; if(now - last < cooldown) return {ok:false, remain: Math.ceil((cooldown - (now-last))/1000)}; s[REPORTER.id] = now; localStorage.setItem('civic_rate', JSON.stringify(s)); return {ok:true}; }

/* ------------------------
  Cloudinary upload helper (optional)
*/
async function uploadToCloudinaryDataUrl(dataUrl){
  if(!CLOUD_NAME || !UPLOAD_PRESET) return null;
  const blob = dataURLtoBlob(dataUrl);
  const fd = new FormData(); fd.append('file', blob, 'photo.jpg'); fd.append('upload_preset', UPLOAD_PRESET);
  const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, {method:'POST', body: fd});
  if(!res.ok) throw new Error('Cloudinary upload failed'); const json=await res.json(); return json.secure_url;
}

/* ------------------------
  Submit report: build payload, heuristics, save locally, send webhook attempt
*/
submitBtn.addEventListener('click', async ()=>{
  const cat = categoryEl.value; const desc = descEl.value.trim();
  if(!cat){ alert('Please select a category'); return; } if(!desc){ alert('Please describe the issue'); return; }
  // rate limit
  const rc = canSubmitNow(); if(!rc.ok){ alert(`Please wait ${rc.remain}s before submitting another report (rate limit).`); return; }
  // location check
  if(!currentLat || !currentLng){
    if(!confirm('No coordinates set. Continue and rely only on manual address?')) return;
  }
  // duplicate check
  const duplicates = checkDuplicatesBeforeSubmit();
  if(duplicates.length && !confirm('Similar reports nearby found. Still submit?')) return;
  submitBtn.disabled = true; showStatus('Preparing report (compressing images & building payload)...', 'info');

  // upload images if cloudinary set, otherwise keep dataURL
  const photoUrls = [];
  for(const p of photos){
    try{ if(CLOUD_NAME && UPLOAD_PRESET){ const u = await uploadToCloudinaryDataUrl(p.dataUrl); photoUrls.push(u || p.dataUrl); } else photoUrls.push(p.dataUrl); }catch(e){ console.warn('upload failed', e); photoUrls.push(p.dataUrl); }
  }

  // plus code
  let plus = null; try{ if(currentLat && currentLng) plus = OpenLocationCode.encode(currentLat, currentLng); }catch(e){ plus = null; }

  const payload = {
    id: 'TICKET_' + uid(8),
    timestamp: nowISO(),
    category: cat,
    description: desc,
    photos: photoUrls,
    lat: currentLat,
    lng: currentLng,
    accuracy: currentAccuracy || null,
    plus_code: plus,
    osm_link: (currentLat && currentLng) ? `https://www.openstreetmap.org/?mlat=${currentLat}&mlon=${currentLng}&zoom=17` : null,
    manual_address: manualAddr.value || null,
    anonymous: anonymousChk.checked,
    contact_name: anonymousChk.checked ? null : document.getElementById('nameInput').value || null,
    contact_phone: anonymousChk.checked ? null : document.getElementById('phoneInput').value || null,
    reporter_id: REPORTER.id,
    reporter_trust: trustScore(),
    priority: document.getElementById('priority').value,
    ui_language: SETTINGS.uiLang,
    mic_language: document.getElementById('micLang').value,
    verification: 'pending',
    confirmed: 0
  };

  // save locally (demo feed)
  const list = loadJSON(STORAGE_KEY, []); list.unshift(payload); saveJSON(STORAGE_KEY, list); renderFeed();

  // send to webhook (best-effort)
  try{ if(N8N_WEBHOOK_URL && N8N_WEBHOOK_URL.startsWith('http')){ await fetch(N8N_WEBHOOK_URL, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)}); } }catch(e){ console.warn('webhook failed', e); }

  // reward reporter points (optimistic)
  REPORTER.points = (REPORTER.points||0) + 5; updateReporter(REPORTER);

  showStatus('Submitted. Ticket: '+payload.id+' — verification pending', 'success');
  submitBtn.disabled = false; // reset
  // reset some UI elements for convenience
  descEl.value = ''; photos = []; renderPhotos(); updatePreview(); manualAddr.value = manualAddr.value; // keep manual address for reuse
  // send browser notification if enabled
  if(SETTINGS.notif) try{ if(Notification.permission === 'granted') new Notification('Report submitted', {body:'Ticket: '+payload.id}); }catch(e){}
});

/* ------------------------
  Feed rendering + confirm (crowd verify)
*/
function renderFeed(){
  const list = loadJSON(STORAGE_KEY, []);
  feedEl.innerHTML = '';
  if(!list.length) { feedEl.innerHTML = '<div class="note">No reports yet.</div>'; return; }
  list.forEach((r, idx)=>{
    const div = document.createElement('div'); div.className = 'feed-item';
    div.innerHTML = `<div style="display:flex;justify-content:space-between"><div><strong>${r.category}</strong><div class="tiny">${r.timestamp.split('T')[0]}</div></div><div class="tiny">#${r.id}</div></div>
      <div style="margin-top:8px">${r.description.slice(0,200)}</div>
      <div class="tiny" style="margin-top:8px">${r.manual_address || (r.lat?('📍 '+Number(r.lat).toFixed(6)):'')}</div>
      <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
        <button class="btn ghost small confirm-btn" data-idx="${idx}">Confirm (I saw this)</button>
        <div class="tiny" id="confirm-count-${r.id}">Confirmed: ${r.confirmed||0}</div>
        <div style="flex:1"></div>
        <div class="tiny">Status: <strong id="status-${r.id}">${r.verification}</strong></div>
      </div>`;
    feedEl.appendChild(div);
  });
  // attach handlers
  feedEl.querySelectorAll('.confirm-btn').forEach(b=>{ b.onclick = ()=>{ const idx = Number(b.dataset.idx); const list = loadJSON(STORAGE_KEY, []); const rpt = list[idx]; if(!rpt) return; rpt.confirmed = (rpt.confirmed||0)+1; if(rpt.confirmed >= 3){ rpt.verification = 'verified'; showStatus('Report '+rpt.id+' verified by community','success'); } saveJSON(STORAGE_KEY, list); // reward reporter if same user
      if(rpt.reporter_id === REPORTER.id){ REPORTER.valid = (REPORTER.valid||0)+1; updateReporter(REPORTER); } renderFeed(); }; });
}
renderFeed();

/* ------------------------
  Notifications & in-app notifications
*/
let notifCount = 0;
function notifyInApp(title, body){
  notifCount++; notifCountEl.textContent = notifCount;
  try{ if(SETTINGS.notif && Notification.permission === 'granted') new Notification(title, {body}); }catch(e){}
}

/* ------------------------
  Export CSV
*/
function reportsToCSV(list){
  const rows = [['id','timestamp','category','description','lat','lng','manual_address','anonymous','reporter_id','verification']];
  list.forEach(r => rows.push([r.id, r.timestamp, r.category, (r.description||'').replace(/[\r\n]+/g,' '), r.lat, r.lng, (r.manual_address||''), r.anonymous, r.reporter_id, r.verification]));
  return rows.map(r=>r.map(c=>`"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\n');
}
exportCSVBtn.addEventListener('click', ()=>{
  const list = loadJSON(STORAGE_KEY, []);
  if(!list.length){ alert('No reports to export'); return; }
  const csv = reportsToCSV(list);
  const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'reports.csv'; a.click(); URL.revokeObjectURL(url);
});

/* ------------------------
  Clear demo storage
*/
clearStorageBtn.addEventListener('click', ()=>{ if(!confirm('Clear demo storage (reports & reporter data)?')) return; localStorage.removeItem(STORAGE_KEY); localStorage.removeItem(REPORTER_KEY); renderFeed(); REPORTER = initReporter(); applySettingsUI(); showStatus('Demo storage cleared','info'); });

/* ------------------------
  Hamburger menu logic
*/
hamburgerBtn.addEventListener('click', ()=>{ hamburgerModal.style.display = 'block'; });
closeMenuBtn.addEventListener('click', ()=>{ hamburgerModal.style.display = 'none'; });
menuAbout.addEventListener('click', ()=>{ alert('Citizen Civic Sense\\nDemo app for reporting civic issues. SIH-ready.'); });
menuFAQ.addEventListener('click', ()=>{ alert('FAQ:\\n- Use GPS or search to set location.\\n- Upload up to 4 photos.\\n- You can report anonymously.'); });
menuSupport.addEventListener('click', ()=>{ window.location.href = 'mailto:help@civic-sense.example?subject=Support%20request%20(Civic%20Sense)'; });
menuHistory.addEventListener('click', ()=>{ // show modal listing user's reports
  const list = loadJSON(STORAGE_KEY,[]).filter(r=> r.reporter_id === REPORTER.id); if(!list.length){ alert('You have no reports yet.'); return; } const ids = list.map(r=>r.id+' ('+r.category+') — '+r.verification).join('\\n'); alert('Your reports:\\n'+ids);
});
menuModerator.addEventListener('click', ()=>{ const key = prompt('Enter moderator key (demo):'); if(key === 'moddemo123'){ showModeratorDashboard(); } else alert('Wrong key'); });
menuTheme.addEventListener('click', ()=>{ const v = prompt('Choose theme: light or dark', SETTINGS.theme); if(v){ SETTINGS.theme = v; saveSettings(SETTINGS); applySettingsUI(); }});
menuLogout.addEventListener('click', ()=>{ if(confirm('Reset demo settings & reporter data?')){ localStorage.removeItem(REPORTER_KEY); localStorage.removeItem(SETTINGS_KEY); location.reload(); } });

/* ------------------------
  Moderator dashboard (demo) — simple UI to mark verified/invalid
*/
function showModeratorDashboard(){
  const list = loadJSON(STORAGE_KEY, []); const sel = list.map((r,i)=> `${i}: ${r.id} | ${r.category} | ${r.verification} | ${r.manual_address||r.lat}`).join('\\n'); const idx = prompt('Moderator - select item number to change status:\\n'+sel); if(idx===null) return; const i = Number(idx); if(isNaN(i) || !list[i]){ alert('Invalid'); return; } const choice = prompt('Mark as (verified/in-progress/resolved/invalid):', list[i].verification); if(!choice) return; list[i].verification = choice; saveJSON(STORAGE_KEY, list); if(choice === 'verified'){ // reward reporter
    const rep = list[i].reporter_id; if(rep === REPORTER.id){ REPORTER.valid = (REPORTER.valid||0)+1; updateReporter(REPORTER); } } renderFeed(); alert('Updated'); }

/* ------------------------
  Leaderboard (local demo)
*/
leaderboardBtn.addEventListener('click', ()=>{ // find local reporters from storage
  const list = loadJSON(STORAGE_KEY, []); const byReporter = {}; list.forEach(r=>{ byReporter[r.reporter_id] = byReporter[r.reporter_id] || {id:r.reporter_id, verified:0, total:0}; byReporter[r.reporter_id].total++; if(r.verification === 'verified') byReporter[r.reporter_id].verified++; }); const arr = Object.values(byReporter); arr.sort((a,b)=> b.verified - a.verified); const top = arr.slice(0,10).map(a=>`${a.id} — verified:${a.verified} total:${a.total}`).join('\\n'); alert('Leaderboard (demo):\\n'+(top || 'No activity yet')); });

/* ------------------------
  Utility: showStatus
*/
function showStatus(msg, type='info'){ formStatus.style.display='block'; formStatus.className = 'status ' + (type==='info'?'info':(type==='warn'?'warn':(type==='success'?'success':'error'))); formStatus.textContent = msg; }

/* ------------------------
  Init functions
*/
function updateReporterUI(){ const r = getReporter(); reporterIdDisplay.textContent = r.id; trustScoreEl.textContent = trustScore(); pointsCountEl.textContent = r.points || 0; badgesEl.textContent = (r.badges && r.badges.length)? r.badges.join(', '): '-'; }
function updatePreview(){ updatePreview(); } // placeholder to ensure function exists; above updatePreview defined

// ensure map initialized for later
initMap(); updateReporterUI(); renderPhotos(); renderFeed(); applySettingsUI();
showStatus('Ready — mobile-first, multi-language, anti-abuse heuristics enabled (demo).', 'info');

/* End of app */
</script>
</body>
</html>
